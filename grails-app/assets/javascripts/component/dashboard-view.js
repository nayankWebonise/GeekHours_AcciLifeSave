var DashBoard = React.createClass({
    componentDidMount: function() {
        this.connectToSocket();
        var DEFAULT_LAT_LONG = [37.090240, -95.712891],
            DEFAULT_ZOOM = 17;

        L.mapbox.accessToken = 'pk.eyJ1IjoiYXNsYXRlciIsImEiOiItYTNLNkkwIn0.uf1rwYpeylp32z8EVOjXpg';
        this.map = L.mapbox.map('map', 'mapbox.streets', {attributionControl: false}).
            setView(DEFAULT_LAT_LONG, DEFAULT_ZOOM).
            addControl(L.mapbox.geocoderControl('mapbox.places'));
        L.control.scale({ position: 'bottomleft' }).addTo(this.map);
        this.drawnItems = L.mapbox.featureLayer().addTo(this.map);

        this.drawnItems.on('layeradd', function(e) {
            var marker = e.layer,
                feature = marker.feature;
            marker.setIcon(L.icon(feature.properties.icon));
        });

        window.onbeforeunload = function(event) {
            if (this.stompClient) {
                this.stompClient.disconnect();
                this.socket.close();
            }
        }.bind(this);

        var carData = this.getCarData(0);
        var geoJson = this.getGeoJson(carData);
        this.drawnItems.setGeoJSON(geoJson);
        this.map.setView(carData.reverse());
        this.showCar();
    },

    showCar: function() {
        var index = 1;
        this.timer = setInterval(function() {
            var carData = this.getCarData(index);
            this.map.setView(carData.reverse());
            var layers = this.drawnItems.getLayers();
            if(layers.length) {
                var latlng = L.latLng(carData[0], carData[1]);
                layers[0].setLatLng(latlng);
            }
            index += 1;
            this.sendVehicleLocation(carData[0], carData[1]);
        }.bind(this), 2000);
    },

    connectToSocket: function() {
        var userName = 'vijay';
        var carInfoTopicName = '/topic/' + userName;
        var socketName = '/myvehicle';
        this.socket = new SockJS(socketName);
        this.stompClient = Stomp.over(this.socket);
        this.stompClient.connect({}, function(frame) {
            this.stompClient.subscribe(carInfoTopicName, function(data) {
                this.showNotification(data);
            }.bind(this));
        }.bind(this));
    },

    sendVehicleLocation: function(latitude, longitude) {
        var mapBounds = this.getMapBounds();
        this.stompClient.send("/app/myvehicle", {}, JSON.stringify({
            username : 'vijay',
            latitude : latitude,
            longitude : longitude,
            radius: mapBounds.radius
        }));
    },

    getMapBounds: function() {
        var bounds = this.drawnItems._map.getBounds();
        var radius = bounds._northEast.distanceTo(bounds._southWest) / 2;
        var center = this.drawnItems._map.getCenter();
        return {
            latitude: center.lat,
            longitude: center.lng,
            radius: radius
        };
    },

    showNotification: function() {
        console.log('Coming.....');
        //show notification here
    },

    getGeoJson: function(carData) {
        return {
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [carData[0], carData[1]]
            },
            properties: {
                title: 'My Car',
                icon: {
                    iconUrl: '/assets/car.png',
                    iconSize: [30, 30], // size of the icon
                    iconAnchor: [20, 20], // point of the icon which will correspond to marker's location
                    popupAnchor: [0, -25], // point from which the popup should open relative to the iconAnchor
                    className: 'dot'
                }
            }
        };
    },

    render: function() {
        return (
            <div id="map">
            </div>
        );
    },

    getCarData: function(index) {
        if(index === 221) {
            clearInterval(this.timer);
        }
        var coordinates = [[
            73.78372371196747,
            18.507401507646623
          ],
          [
            73.78361642360687,
            18.507554117116182
          ],
          [
            73.78349304199219,
            18.507691465522445
          ],
          [
            73.78332674503326,
            18.507854248676026
          ],
          [
            73.78320872783661,
            18.507950901100227
          ],
          [
            73.78311216831207,
            18.50808316222382
          ],
          [
            73.78300487995148,
            18.508200162363362
          ],
          [
            73.78287076950073,
            18.508357858077062
          ],
          [
            73.78274202346802,
            18.50852064059686
          ],
          [
            73.7826132774353,
            18.508678336015294
          ],
          [
            73.78250062465668,
            18.508830944346403
          ],
          [
            73.78240942955017,
            18.509054769652536
          ],
          [
            73.78235578536987,
            18.509278594665957
          ],
          [
            73.78228604793549,
            18.509451550157667
          ],
          [
            73.78225386142731,
            18.50960924471835
          ],
          [
            73.78220021724701,
            18.509787286789667
          ],
          [
            73.78214657306671,
            18.509970415584064
          ],
          [
            73.78209292888641,
            18.510173891792448
          ],
          [
            73.78204464912415,
            18.51043841050168
          ],
          [
            73.78202319145203,
            18.510601191042603
          ],
          [
            73.78200173377991,
            18.51081992715066
          ],
          [
            73.78200709819794,
            18.511048836731778
          ],
          [
            73.78202855587006,
            18.511303180351693
          ],
          [
            73.78205001354218,
            18.51152191556246
          ],
          [
            73.78208220005035,
            18.511710129357244
          ],
          [
            73.78213047981262,
            18.51190851664656
          ],
          [
            73.78218412399292,
            18.512127251083566
          ],
          [
            73.78223776817322,
            18.51231037737395
          ],
          [
            73.78229677677153,
            18.51248841663504
          ],
          [
            73.78234505653381,
            18.512691889849453
          ],
          [
            73.78239870071411,
            18.512900449643116
          ],
          [
            73.78243625164032,
            18.513078488290258
          ],
          [
            73.78248453140259,
            18.51323109269749
          ],
          [
            73.78252744674683,
            18.51341421780654
          ],
          [
            73.78256499767303,
            18.51361768992004
          ],
          [
            73.7825757265091,
            18.513836422172194
          ],
          [
            73.78254354000092,
            18.51401445984545
          ],
          [
            73.78251135349274,
            18.51418232376767
          ],
          [
            73.78245234489441,
            18.514355274303174
          ],
          [
            73.78239870071411,
            18.514507877571667
          ],
          [
            73.78232896327972,
            18.51466556747279
          ],
          [
            73.7822699546814,
            18.51481308370032
          ],
          [
            73.78218948841095,
            18.51497586007965
          ],
          [
            73.78212511539459,
            18.515113202529257
          ],
          [
            73.78205537796019,
            18.515281065373486
          ],
          [
            73.78195881843567,
            18.515484535266907
          ],
          [
            73.78188371658325,
            18.515642224267857
          ],
          [
            73.78181397914885,
            18.515784652917993
          ],
          [
            73.78174960613251,
            18.515932168180623
          ],
          [
            73.78165304660796,
            18.516125463849477
          ],
          [
            73.78158330917358,
            18.516283152259668
          ],
          [
            73.78150284290314,
            18.51644592724032
          ],
          [
            73.78142237663269,
            18.516618875487577
          ],
          [
            73.78130435943604,
            18.516776563442978
          ],
          [
            73.78119707107544,
            18.51689864434088
          ],
          [
            73.78106832504271,
            18.51706141873589
          ],
          [
            73.78093957901001,
            18.517178412736655
          ],
          [
            73.78078401088715,
            18.517305580038034
          ],
          [
            73.78062844276428,
            18.517442920617334
          ],
          [
            73.78043532371521,
            18.517595521131682
          ],
          [
            73.78030121326447,
            18.517712514767158
          ],
          [
            73.78015637397766,
            18.51781933497315
          ],
          [
            73.77996325492859,
            18.51799736850157
          ],
          [
            73.7798023223877,
            18.518124535194143
          ],
          [
            73.77966821193695,
            18.518256788454128
          ],
          [
            73.77955555915833,
            18.518358521661465
          ],
          [
            73.7794429063797,
            18.51846534146405
          ],
          [
            73.77931416034698,
            18.51856198789464
          ],
          [
            73.77921223640442,
            18.518668807570155
          ],
          [
            73.77909421920775,
            18.51880106040934
          ],
          [
            73.77899765968323,
            18.51892313986242
          ],
          [
            73.77892792224884,
            18.519060479143036
          ],
          [
            73.77883672714233,
            18.519207991580846
          ],
          [
            73.778777718544,
            18.519350417262153
          ],
          [
            73.7787401676178,
            18.51952336257288
          ],
          [
            73.77875089645384,
            18.519686134470312
          ],
          [
            73.77876162528992,
            18.51984890621283
          ],
          [
            73.77878844738007,
            18.519981158139565
          ],
          [
            73.77881526947021,
            18.520082890321323
          ],
          [
            73.77883136272429,
            18.52019988225553
          ],
          [
            73.77887427806854,
            18.520347393710704
          ],
          [
            73.77892255783081,
            18.520489818443234
          ],
          [
            73.77897620201111,
            18.520611896691026
          ],
          [
            73.77904057502747,
            18.520749234615618
          ],
          [
            73.77911031246185,
            18.520901832180293
          ],
          [
            73.77919614315033,
            18.52106968934417
          ],
          [
            73.77925515174864,
            18.521222286622915
          ],
          [
            73.7792980670929,
            18.521344364347883
          ],
          [
            73.77936780452728,
            18.521481701684316
          ],
          [
            73.7794429063797,
            18.52162921203394
          ],
          [
            73.77948582172394,
            18.521736029793896
          ],
          [
            73.77955555915833,
            18.5218530205973
          ],
          [
            73.77959847450255,
            18.522005617177115
          ],
          [
            73.7796950340271,
            18.522158213620788
          ],
          [
            73.77975404262543,
            18.522310809928292
          ],
          [
            73.77982378005981,
            18.522432886876267
          ],
          [
            73.7798935174942,
            18.522626175199004
          ],
          [
            73.77999007701874,
            18.522809290250606
          ],
          [
            73.7800544500351,
            18.523007664668565
          ],
          [
            73.78014028072357,
            18.523185692796467
          ],
          [
            73.78021001815796,
            18.523348461208354
          ],
          [
            73.78028512001038,
            18.523521402476227
          ],
          [
            73.78039240837097,
            18.52376046805853
          ],
          [
            73.78048896789551,
            18.52396392786533
          ],
          [
            73.78057479858398,
            18.524157214457556
          ],
          [
            73.78069281578064,
            18.524396279150984
          ],
          [
            73.78078401088715,
            18.524594651727973
          ],
          [
            73.78089666366577,
            18.52477776467168
          ],
          [
            73.78099858760834,
            18.524930358641658
          ],
          [
            73.78109514713287,
            18.52509821185135
          ],
          [
            73.7812077999115,
            18.52526097844278
          ],
          [
            73.781298995018,
            18.52542374487929
          ],
          [
            73.78144383430481,
            18.525627202707007
          ],
          [
            73.78158867359161,
            18.525815400982104
          ],
          [
            73.78175497055054,
            18.52596290759347
          ],
          [
            73.78193736076355,
            18.52611041407758
          ],
          [
            73.78208220005035,
            18.52625792043442
          ],
          [
            73.78224313259125,
            18.52641559950274
          ],
          [
            73.78242015838623,
            18.52657836484009
          ],
          [
            73.78259718418121,
            18.526751302841255
          ],
          [
            73.78277957439421,
            18.526919154263336
          ],
          [
            73.78298342227936,
            18.527076832721843
          ],
          [
            73.78314435482025,
            18.527173474285824
          ],
          [
            73.78328919410706,
            18.527244683824332
          ],
          [
            73.78342866897583,
            18.527305720548007
          ],
          [
            73.78355205059052,
            18.527351498076467
          ],
          [
            73.78371834754944,
            18.52739727559269
          ],
          [
            73.7838739156723,
            18.52742270754083
          ],
          [
            73.78404021263123,
            18.52746339865001
          ],
          [
            73.78419578075409,
            18.52745831226189
          ],
          [
            73.78435671329498,
            18.52745831226189
          ],
          [
            73.78449082374573,
            18.5274481394852
          ],
          [
            73.78464102745056,
            18.52742270754083
          ],
          [
            73.78474295139313,
            18.527387102812362
          ],
          [
            73.78489851951599,
            18.527356584467768
          ],
          [
            73.78503262996674,
            18.527320979725527
          ],
          [
            73.7851881980896,
            18.527280288582464
          ],
          [
            73.78538131713867,
            18.52721925184969
          ],
          [
            73.78557443618774,
            18.527168387889077
          ],
          [
            73.78577828407288,
            18.527066659922447
          ],
          [
            73.78596603870392,
            18.526995450309794
          ],
          [
            73.78616988658905,
            18.52691406785902
          ],
          [
            73.78637909889221,
            18.52684794458924
          ],
          [
            73.78652393817902,
            18.526791994110226
          ],
          [
            73.78668487071991,
            18.526725870793236
          ],
          [
            73.7868458032608,
            18.52667500668583
          ],
          [
            73.7869906425476,
            18.526598710496376
          ],
          [
            73.78714084625244,
            18.526552932766347
          ],
          [
            73.78729104995728,
            18.526502068607506
          ],
          [
            73.78744661808014,
            18.52646137726954
          ],
          [
            73.787602186203,
            18.52642068592188
          ],
          [
            73.78775238990784,
            18.52637490814419
          ],
          [
            73.78787577152251,
            18.526339303197513
          ],
          [
            73.78804743289948,
            18.526293525398046
          ],
          [
            73.78824591636658,
            18.526263006858244
          ],
          [
            73.78841757774353,
            18.52625283401045
          ],
          [
            73.78858923912048,
            18.526242661162033
          ],
          [
            73.78880381584166,
            18.52624774758631
          ],
          [
            73.78899157047272,
            18.52625792043442
          ],
          [
            73.7891685962677,
            18.526278266128838
          ],
          [
            73.78935098648071,
            18.526308784665893
          ],
          [
            73.78957092761993,
            18.526395253824674
          ],
          [
            73.78974258899689,
            18.526451204433528
          ],
          [
            73.78990888595581,
            18.526507155024074
          ],
          [
            73.79010200500488,
            18.52665466103864
          ],
          [
            73.79030585289001,
            18.526802166925947
          ],
          [
            73.79053115844727,
            18.526985277505577
          ],
          [
            73.79066526889801,
            18.527173474285824
          ],
          [
            73.79083693027495,
            18.527356584467768
          ],
          [
            73.79097104072571,
            18.527600731071963
          ],
          [
            73.79112124443054,
            18.52781435906464
          ],
          [
            73.79121780395508,
            18.527987295815564
          ],
          [
            73.79127144813538,
            18.52817549149281
          ],
          [
            73.79130899906158,
            18.52834842787843
          ],
          [
            73.79136264324188,
            18.528490845947
          ],
          [
            73.7914377450943,
            18.528673954717977
          ],
          [
            73.79150211811064,
            18.528841804252412
          ],
          [
            73.79155576229095,
            18.529035085330346
          ],
          [
            73.7916362285614,
            18.529233452525187
          ],
          [
            73.79170596599579,
            18.52944707847761
          ],
          [
            73.7917810678482,
            18.529665790485662
          ],
          [
            73.79184007644653,
            18.529833639046238
          ],
          [
            73.79189372062683,
            18.52999640112942
          ],
          [
            73.79195272922516,
            18.530148990441642
          ],
          [
            73.79201710224152,
            18.53033718373913
          ],
          [
            73.79208147525787,
            18.530530463126293
          ],
          [
            73.79213511943817,
            18.530713569712532
          ],
          [
            73.7921941280365,
            18.530886503530553
          ],
          [
            73.79224777221678,
            18.531034005766497
          ],
          [
            73.7923014163971,
            18.531186594152487
          ],
          [
            73.79236578941345,
            18.53136461376397
          ],
          [
            73.79242479801178,
            18.53152228812218
          ],
          [
            73.79246771335602,
            18.53167487607227
          ],
          [
            73.79257500171661,
            18.531827463886167
          ],
          [
            73.79270374774933,
            18.531990224070814
          ],
          [
            73.7927895784378,
            18.532122466606747
          ],
          [
            73.79291832447052,
            18.532290312754974
          ],
          [
            73.7930577993393,
            18.532458158738383
          ],
          [
            73.79318118095398,
            18.53264634949348
          ],
          [
            73.79336357116699,
            18.532936264575547
          ],
          [
            73.79365861415862,
            18.533317731039556
          ],
          [
            73.79386246204376,
            18.5335822139548
          ],
          [
            73.79400730133057,
            18.53388229984375
          ],
          [
            73.79423797130585,
            18.534228160892653
          ],
          [
            73.79440426826477,
            18.534507900934912
          ],
          [
            73.79459202289581,
            18.534807985198434
          ],
          [
            73.7947529554367,
            18.53509281045267
          ],
          [
            73.79490852355957,
            18.535347118314206
          ],
          [
            73.79509627819061,
            18.53562685652481
          ],
          [
            73.79516065120697,
            18.535784526950813
          ],
          [
            73.79528939723967,
            18.53596254177308
          ],
          [
            73.79536986351012,
            18.536110039628163
          ],
          [
            73.79549324512482,
            18.53630839861187
          ],
          [
            73.79562199115753,
            18.53647115452909
          ],
          [
            73.79574000835419,
            18.53673054645175
          ],
          [
            73.79589021205902,
            18.53693907692758
          ],
          [
            73.79595458507536,
            18.537056057326986
          ],
          [
            73.796067237854,
            18.537249329115774
          ],
          [
            73.79616916179657,
            18.537391739767624
          ],
          [
            73.79621207714081,
            18.537473117229673
          ],
          [
            73.79624962806702,
            18.537544322477164
          ],
          [
            73.7962818145752,
            18.537615527695003
          ]];
        return coordinates[index];
    }
});

React.render(<DashBoard/>, document.getElementById("wrapper"));
